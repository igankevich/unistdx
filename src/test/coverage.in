#!/bin/sh

lcovrc_options="@lcovrc_options@"
lcov="@lcov_path@ @lcov_options@ $lcovrc_options"
genhtml="@genhtml_path@ @genhtml_options@ $lcovrc_options"

set -ex
cd "$MESON_BUILD_ROOT"
tmp="coverage.info"
ninja test
ls -R
$lcov --capture --initial --directory . --output-file $tmp.initial --quiet
$lcov --capture --directory . --output-file $tmp.actual --quiet
$lcov -a $tmp.initial -a $tmp.actual -o $tmp.total --quiet
for pattern in \
    /gnu/store/\* \
    $HOME/.guix-profile/\* \
    /usr/\* \
    \*test\*
do
    $lcov --remove $tmp.total "$pattern" --output-file $tmp.new --quiet
    mv $tmp.new $tmp.total
done
mv $tmp.total $tmp
$lcov --summary $tmp
$genhtml $tmp --output-directory lcov --quiet
rm $tmp.*
