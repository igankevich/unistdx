#!/bin/sh

lcovrc_options="@lcovrc_options@"
lcov="@lcov_path@ @lcov_options@ $lcovrc_options"
genhtml="@genhtml_path@ @genhtml_options@ $lcovrc_options"

set -e
cd "$MESON_BUILD_ROOT"
tmp="coverage.info"
$lcov --capture --initial --directory . --output-file $tmp.initial --quiet
ninja test
$lcov --capture --directory . --output-file $tmp.actual --quiet
$lcov -a $tmp.initial -a $tmp.actual -o $tmp.total --quiet
for pattern in /usr/include/\* /usr/local/include/\* \*test\*
do
    $lcov --remove $tmp.total "$pattern" --output-file $tmp.new --quiet
    mv $tmp.new $tmp.total
done
mv $tmp.total $tmp
$lcov --summary $tmp
$genhtml $tmp --output-directory lcov --quiet
rm $tmp.*
