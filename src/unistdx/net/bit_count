#ifndef UNISTDX_NET_BIT_COUNT
#define UNISTDX_NET_BIT_COUNT

#include <bitset>

#include <unistdx/config>

namespace sys {

	/**
	\brief Count the number of bits that are set in \p value.
	\date 2018-05-23
	\author Ivan Gankevich
	\arg Uses \c std::bitset for generic implementation.
	\arg There are optimised implementations for standard
	unsigned integer types.
	*/
	template<class T>
	inline unsigned int
	bit_count(T value) noexcept {
		union {
			T val;
			std::bitset<sizeof(T) * 8> bits;
		} x{};
		x.val = value;
		return x.bits.count();
	}

	#if defined(UNISTDX_HAVE_BUILTIN_POPCOUNT)
	/// Specialisation for unsigned int.
	template<>
	inline unsigned int
	bit_count<unsigned int>(unsigned int value) noexcept {
		return __builtin_popcount(value);
	}
	#endif

	#if defined(UNISTDX_HAVE_BUILTIN_POPCOUNTL)
	/// Specialisation for unsigned long.
	template<>
	inline unsigned int
	bit_count<unsigned long>(unsigned long value) noexcept {
		return __builtin_popcountl(value);
	}
	#endif

	#if defined(UNISTDX_HAVE_BUILTIN_POPCOUNTLL) && \
		defined(UNISTDX_HAVE_LONG_LONG)
	/// Specialisation for unsigned long long.
	template<>
	inline unsigned int
	bit_count<unsigned long long>(unsigned long long value) noexcept {
		return __builtin_popcountll(value);
	}
	#endif

}

#endif // vim:filetype=cpp
