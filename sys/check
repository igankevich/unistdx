#ifndef SYS_BITS_CHECK_HH
#define SYS_BITS_CHECK_HH

#include <system_error>
#include <ostream>

#define UNISTDX_THROW_BAD_CALL() \
	throw ::sys::bad_call(__FILE__, __LINE__, __func__)

#define UNISTDX_CHECK(func) \
{ \
	if ((func) == -1) { \
		throw ::sys::bad_call(__FILE__, __LINE__, __func__); \
	} \
}

#define UNISTDX_CHECK2(func, ret) \
{ \
	if ((func) == (ret)) { \
		throw ::sys::bad_call(__FILE__, __LINE__, __func__); \
	} \
}

#define UNISTDX_CHECK_IF_NOT(good_err, func) \
{ \
	if ((func) == -1 && errno != (good_err)) { \
		throw ::sys::bad_call(__FILE__, __LINE__, __func__); \
	} \
}

namespace sys {

	struct bad_call: public std::system_error {

		inline
		bad_call(const char* file, const int line, const char* function) noexcept:
		std::system_error(errno, std::generic_category()),
		_file(file), _line(line), _function(function)
		{}

		inline friend std::ostream&
		operator<<(std::ostream& out, const bad_call& rhs) {
			return out
				<< rhs._file << ':'
				<< rhs._line << ':'
				<< rhs._function << ' '
				<< rhs.what();
		}

	private:
		const char* _file;
		const int _line;
		const char* _function;
	};

}

#endif // SYS_BITS_CHECK_HH
// vi:ft=cpp
